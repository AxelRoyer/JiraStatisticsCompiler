var gulp    = require("./gulpfile"),
    express = require("express"),
    gaze    = require("gaze"),
    path    = require("path"),
    tinylr  = require("tiny-lr-fork")(),
    conf    = {
        port    : 4000
    };

/** Livereload */

tinylr.listen(35729);
var livereload  = function(
        evt,
        filepath
        ) {
        tinylr.changed(
            {
                body    : {
                    files   : path.relative(
                        __dirname,
                        filepath
                    )
                }
            }
        )
    };

/** Initial webpack */

gulp.tasks.webpack.fn();

/** Server */

var app = express()
    .use(express.static(__dirname))
    .listen(
        conf.port,
        function() {
            console.log("Server running at http://localhost:"+conf.port)
        }
    );

/** Gaze */

gaze(
    [
        "entry.js",
        "../*.js"
    ],
    function(
        err,
        watcher
        ) {
        this.on(
            "all",
            function(
                event,
                filepath
                ) {
                gulp.tasks.webpack.fn()
            }
        )
    }
);
gaze(
    "bundle.js",
    function(
        err,
        watcher
        ) {
        watcher.on(
            "all",
            function(
                event,
                filepath
                ) {
                livereload(
                    event,
                    filepath
                )
            }
        )
    }
);